PG_PACKAGE_DIR=/var/vcap/package/postgres
function database_ready() {
  <% if properties.postgres %>
  HOST='<%= properties.postgres.host %>'
  PORT='<%= properties.postgres.port || 5432 %>'
  USER='<%= properties.postgres.user %>'
  PASSWORD='<%= properties.postgres.password %>'
  DBNAME='<%= properties.postgres.database %>'
  echo Testing postgresl: psql -d $DBNAME -p $PORT -U vcap -c "select 1;"
  LD_LIBRARY_PATH=$PG_PACKAGE_DIR/lib $PG_PACKAGE_DIR/bin/psql -d $DBNAME -p $PORT -U vcap -c "select 1;"
  <% else %>
  echo 'No database configured'
  true
  <% end %>
}

function wait_for_database() {
  while [[ ! database_ready ]]
  do
    echo "Waiting for database availability"
    sleep 1;
  done
}
