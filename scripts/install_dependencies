#!/usr/bin/env bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

if [[ $EUID -ne 0 ]]; then
  echo "ERROR: This script must be run as root" 1>&2
  exit 1
fi

cd $(dirname $0)/..
release_path=$(pwd)

bosh_dir=${BOSH_DIR:-/bosh}

apt-get update
apt-get install -y --force-yes build-essential flex bison upstart runit patch g++ libxml2-dev \
  libxslt-dev libpq-dev git-core libsqlite3-dev vim curl || exit 1

if [[ ! -d /home/vcap ]]
then
  bosh_users_password=vcap
  /usr/sbin/addgroup --system admin
  /usr/sbin/adduser --disabled-password --gecos Ubuntu vcap
  echo "vcap:${bosh_users_password}" | /usr/sbin/chpasswd
  echo "root:${bosh_users_password}" | /usr/sbin/chpasswd

  for grp in admin adm audio cdrom dialout floppy video plugdev dip
  do
    /usr/sbin/adduser vcap $grp
  done
fi

if [[ -x /var/vcap/bosh/bin/monit ]]
then
  /var/vcap/bosh/bin/monit -V
else
  export build_dir=/bosh/agent/misc/stemcell/build2/
  work_path="/"
  export chroot="/"
  ${build_dir}/stages/bosh_monit/apply.sh ${work_path} || exit 1
fi

gem install bundler rake --no-ri --no-rdoc
cd ${bosh_dir}
rake bundle_install
rake build

cd ${release_path}
bundle --local

cd ${release_path}