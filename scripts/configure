#!/usr/bin/env bash

# Pass rebuild=1 to force /tmp/release.tgz to be rebuilt

base_dir=/var/vcap
jobs_dir=${base_dir}/data/jobs

cd $(dirname $0)/..
release_path=$(pwd)
scripts=${release_path}/scripts

if [[ -d ${base_dir} ]]
then
  echo Configuring jobs...
else
  echo Run "${scripts}/install" first!
  exit 1
fi

mkdir -p ${jobs_dir}

for job in $(${scripts}/helpers/jobs_to_configure)
do
  job_path=${release_path}/jobs/${job}
  job_version=$(${scripts}/helpers/dev_job_version ${job})
  
  echo Configuring job ${job} ${job_version}...
  
  job_install_path=${jobs_dir}/${job}/${job_version}
  rm -rf ${job_install_path}
  mkdir -p ${job_install_path}
  
  release_tgz=$(${scripts}/helpers/create_release_tgz ${release_path} ${release_tgz} || exit 1)
  
  echo Applying job ${job} using release ${release_tgz}...

  ${scripts}/helpers/apply_jobs ${release_tgz} ${job_path} ${job_install_path} || exit 1
done
