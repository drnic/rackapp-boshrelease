#!/usr/bin/env bash

# Render job templates
# Use example manifest for properties for template rendering

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

manifest_template=$1
if [[ ! -f ${manifest_template} ]]; then
  echo "USAGE: configure MANIFEST_TEMPLATE"
  echo "  # MANIFEST_TEMPLATE - YAML file, contains 'properties' key."
  exit 1
fi


base_dir=/var/vcap
jobs_dir=${base_dir}/data/jobs

cd $(dirname $0)/..
release_path=$(pwd)
scripts=${release_path}/scripts

if [[ -d ${base_dir} ]]
then
  echo Configuring jobs...
else
  echo Run "${scripts}/install" first!
  exit 1
fi

mkdir -p ${jobs_dir}

for job in $(${scripts}/helpers/jobs_to_configure)
do
  job_path=${release_path}/jobs/${job}
  job_version=$(${scripts}/helpers/dev_job_version ${job})
  
  echo Configuring job ${job} ${job_version}...
  
  job_install_path=${jobs_dir}/${job}/${job_version}
  rm -rf ${job_install_path}
  mkdir -p ${job_install_path}
  
  release_tgz=$(${scripts}/helpers/create_release_tgz ${release_path})
  
  echo Applying job ${job} using release ${release_tgz}...

  sudo ${scripts}/helpers/apply_jobs ${release_tgz} ${job_path} ${job_install_path} ${manifest_template} || exit 1
done

sudo chown vcap:vcap -R /var/vcap